{"version":3,"sources":["../src/app.controller.ts"],"sourcesContent":["import {\r\n  BadRequestException,\r\n  Body,\r\n  Controller,\r\n  Delete,\r\n  Get,\r\n  HttpCode,\r\n  Post,\r\n  RawBodyRequest,\r\n  Req,\r\n  UnauthorizedException,\r\n  Param,\r\n} from '@nestjs/common';\r\nimport { AppService } from './app.service';\r\nimport { OpenAI } from 'openai';\r\nimport { Request } from 'express';\r\nimport { PhoneService } from './phone/phone.service';\r\nimport { AIService } from './ai/ai.service';\r\nimport { InternetSearchService } from './search/search.service';\r\nimport { DomainService } from './domain/domain.service';\r\nimport { VoiceRecognitionService } from './voice/voice.service';\r\n\r\n@Controller()\r\nexport class AppController {\r\n  constructor(\r\n    private readonly appService: AppService,\r\n    private readonly phoneService: PhoneService,\r\n    private readonly aiService: AIService,\r\n    private readonly searchService: InternetSearchService,\r\n    private readonly domainService: DomainService,\r\n    private readonly voiceService: VoiceRecognitionService,\r\n  ) {}\r\n  private readonly client = new OpenAI();\r\n  private readonly webhookSecret = process.env.OPENAI_WEBHOOK_VERIFICATION_KEY;\r\n\r\n  @Get()\r\n  getHealth(): { status: string; timestamp: string; service: string } {\r\n    return {\r\n      status: 'ok',\r\n      timestamp: new Date().toISOString(),\r\n      service: 'phone-agent',\r\n    };\r\n  }\r\n\r\n  @Get('/hello')\r\n  getHello(): string {\r\n    return this.appService.getHello();\r\n  }\r\n\r\n  @Post('webhook')\r\n  @HttpCode(200)\r\n  async webhook(@Req() req: RawBodyRequest<Request>) {\r\n    console.log('üìû Webhook received at:', new Date().toISOString());\r\n    \r\n    try {\r\n      const event = await this.client.webhooks.unwrap(\r\n        req.rawBody!.toString(),\r\n        req.headers,\r\n        this.webhookSecret!,\r\n      );\r\n\r\n      console.log('‚úÖ Webhook verified, event type:', event.type);\r\n\r\n      if (event.type === 'realtime.call.incoming' && event?.data?.call_id) {\r\n        console.log('üì± Incoming call ID:', event.data.call_id);\r\n        return this.phoneService.handleIncomingCall(event.data.call_id);\r\n      }\r\n\r\n      return 'pong';\r\n    } catch (e) {\r\n      console.error('‚ùå Webhook error:', e);\r\n      if (e instanceof OpenAI.InvalidWebhookSignatureError) {\r\n        throw new UnauthorizedException('Invalid signature');\r\n      } else {\r\n        throw new BadRequestException(e.message);\r\n      }\r\n    }\r\n  }\r\n\r\n  @Get('/search/:query')\r\n  async search(@Param('query') query: string) {\r\n    console.log(`üîç Search endpoint - Query: ${query}`);\r\n    const results = await this.searchService.search(query, 5);\r\n    return {\r\n      query,\r\n      resultsCount: results.length,\r\n      results,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Post('/search')\r\n  @HttpCode(200)\r\n  async searchPost(@Body() body: { query: string; maxResults?: number }) {\r\n    console.log(`üîç POST Search - Query: ${body.query}`);\r\n    const results = await this.searchService.search(body.query, body.maxResults || 5);\r\n    return {\r\n      query: body.query,\r\n      resultsCount: results.length,\r\n      results,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Get('/domain/check/:domain')\r\n  async checkDomain(@Param('domain') domain: string) {\r\n    console.log(`üåê Domain check - Domain: ${domain}`);\r\n    const availability = await this.domainService.checkDomainAvailability(domain);\r\n    const quote = availability.available ? await this.domainService.getDomainQuote(domain) : null;\r\n    return {\r\n      ...availability,\r\n      quote,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Post('/domain/check')\r\n  @HttpCode(200)\r\n  async checkDomainPost(@Body() body: { domain: string }) {\r\n    console.log(`üåê Domain check - Domain: ${body.domain}`);\r\n    const availability = await this.domainService.checkDomainAvailability(body.domain);\r\n    const quote = availability.available ? await this.domainService.getDomainQuote(body.domain) : null;\r\n    return {\r\n      ...availability,\r\n      quote,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Get('/domain/suggest/:keyword')\r\n  async suggestDomains(@Param('keyword') keyword: string) {\r\n    console.log(`üí° Domain suggestions - Keyword: ${keyword}`);\r\n    const suggestions = await this.domainService.getDomainSuggestions(keyword);\r\n    return {\r\n      keyword,\r\n      suggestions,\r\n      count: suggestions.length,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Get('/voice/quality')\r\n  async getVoiceQualityParams() {\r\n    const params = this.voiceService.getOptimalVoiceParameters();\r\n    return {\r\n      ...params,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Post('/voice/analyze')\r\n  @HttpCode(200)\r\n  async analyzeVoice(@Body() body: { transcription: string; audioMetrics?: any }) {\r\n    console.log(`üé§ Voice analysis - Transcription: ${body.transcription.substring(0, 50)}...`);\r\n    const analysis = this.voiceService.analyzeSpeech(body.transcription, body.audioMetrics);\r\n    const report = this.voiceService.generateQualityReport(analysis);\r\n    return {\r\n      analysis,\r\n      report,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Get('/conversation/:callId')\r\n  async getConversation(@Param('callId') callId: string) {\r\n    console.log(`üí¨ Retrieving conversation - Call ID: ${callId}`);\r\n    const memory = this.aiService.getMemory(callId);\r\n    if (!memory) {\r\n      throw new BadRequestException(`No conversation found for call ID: ${callId}`);\r\n    }\r\n    return {\r\n      callId,\r\n      summary: this.aiService.getConversationSummary(callId),\r\n      memory,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Post('/conversation/:callId/message')\r\n  @HttpCode(200)\r\n  async addConversationMessage(\r\n    @Param('callId') callId: string,\r\n    @Body() body: { role: 'user' | 'assistant'; content: string },\r\n  ) {\r\n    console.log(`üí¨ Adding message to conversation - Call ID: ${callId}`);\r\n    this.aiService.addConversationTurn(callId, body.role, body.content);\r\n    const memory = this.aiService.getMemory(callId);\r\n    return {\r\n      callId,\r\n      messageAdded: true,\r\n      memory,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Get('/conversation/:callId/summary')\r\n  async getConversationSummary(@Param('callId') callId: string) {\r\n    console.log(`üìã Getting conversation summary - Call ID: ${callId}`);\r\n    const summary = this.aiService.getConversationSummary(callId);\r\n    if (!summary) {\r\n      throw new BadRequestException(`No conversation found for call ID: ${callId}`);\r\n    }\r\n    return {\r\n      callId,\r\n      summary,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Post('/conversation/:callId/context')\r\n  @HttpCode(200)\r\n  async updateConversationContext(\r\n    @Param('callId') callId: string,\r\n    @Body() body: Record<string, any>,\r\n  ) {\r\n    console.log(`üîß Updating conversation context - Call ID: ${callId}`);\r\n    this.aiService.updateContext(callId, body);\r\n    const memory = this.aiService.getMemory(callId);\r\n    return {\r\n      callId,\r\n      contextUpdated: true,\r\n      memory,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Delete('/conversation/:callId')\r\n  @HttpCode(200)\r\n  async deleteConversation(@Param('callId') callId: string) {\r\n    console.log(`üóëÔ∏è Deleting conversation - Call ID: ${callId}`);\r\n    this.aiService.clearMemory(callId);\r\n    return {\r\n      callId,\r\n      deleted: true,\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n\r\n  @Get('/status')\r\n  async getServiceStatus() {\r\n    return {\r\n      status: 'operational',\r\n      services: {\r\n        phoneAgent: 'active',\r\n        aiConversation: 'active',\r\n        internetSearch: 'active',\r\n        domainCheck: 'active',\r\n        voiceRecognition: 'active',\r\n      },\r\n      timestamp: new Date().toISOString(),\r\n    };\r\n  }\r\n}"],"names":["AppController","getHealth","status","timestamp","Date","toISOString","service","getHello","appService","webhook","req","console","log","event","client","webhooks","unwrap","rawBody","toString","headers","webhookSecret","type","data","call_id","phoneService","handleIncomingCall","e","error","OpenAI","InvalidWebhookSignatureError","UnauthorizedException","BadRequestException","message","search","query","results","searchService","resultsCount","length","searchPost","body","maxResults","checkDomain","domain","availability","domainService","checkDomainAvailability","quote","available","getDomainQuote","checkDomainPost","suggestDomains","keyword","suggestions","getDomainSuggestions","count","getVoiceQualityParams","params","voiceService","getOptimalVoiceParameters","analyzeVoice","transcription","substring","analysis","analyzeSpeech","audioMetrics","report","generateQualityReport","getConversation","callId","memory","aiService","getMemory","summary","getConversationSummary","addConversationMessage","addConversationTurn","role","content","messageAdded","updateConversationContext","updateContext","contextUpdated","deleteConversation","clearMemory","deleted","getServiceStatus","services","phoneAgent","aiConversation","internetSearch","domainCheck","voiceRecognition","process","env","OPENAI_WEBHOOK_VERIFICATION_KEY"],"mappings":"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"}